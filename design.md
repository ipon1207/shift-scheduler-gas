### **件名：GoogleスプレッドシートとGASによるシフト自動割り当てシステムの開発**

#### **1. 概要**
学園祭のイベントシフトを、指定された条件に基づきGoogle Apps Script（GAS）で自動的に割り当てるシステムを開発します。システムはGoogleスプレッドシートをデータベースおよびUIとして使用します。

#### **2. 目的**
メンバーの希望や公平性を考慮しつつ、複雑な割り当て条件を満たしたシフト表を自動で生成すること。また、生成後に手動での微調整も可能とします。

#### **3. 割り当ての基本ルール**
- **役割:** `レジ`, `商品渡し`, `調理` の3種類。
- **人数:** 各役割に1人、つまり各時間帯に合計3人が必要。
- **交代:** 1時間ごと、または30分ごとに交代（定義された時間枠に基づく）。

#### **4. 割り当てロジック**
以下の条件をすべて満たすようにシフトを割り当てます。

##### **4.1. 絶対条件（Must）**
- メンバーのNG時間帯（`availability_sheet`で定義）には割り当てない。
- 連続勤務は絶対にさせない（例：11:00-12:00に勤務したメンバーは、12:00-13:00のシフトには入れない）。

##### **4.2. 希望条件（Want）と優先順位**
以下の条件は「できる限り」満たすべきものであり、優先順位が存在します。実装は、各候補者をスコアリング（点数付け）し、合計スコアが最も高い候補者を選択する方式を推奨します。

**優先度: 高 > 低**
1.  **(D) ペアの回避:** 一度同じ時間帯に組んだメンバー（2人1組のペア）は、次回以降のシフトでなるべく組まないようにする。（**最優先**）
2.  **(B) 役割の未経験:** 今回のシフト割り当て期間内で、まだ経験していない役割を優先的に割り当てる。
3.  **(C) 学年の多様性:** 同じ時間帯に働く3人は、なるべく異なる学年のメンバーで構成する。
4.  **(A) 勤務時間の公平性:** メンバー間の合計勤務時間に大きな偏りが出ないようにする。（**最も優先度が低い**）

##### **4.3. スコアリング方式の例**
各時間帯、各役割の候補者に対して、以下の基準でスコアを計算します。
- **基本点:** 100点
- **(D) ペア回避:** 対象のシフト枠で組むことになる他のメンバーと、過去にペアを組んだことが**なければ** `+1000点`
- **(B) 役割経験:** 対象の役割が未経験であれば `+100点`
- **(C) 学年多様性:** 対象のシフト枠で組むことになる他のメンバーと、学年が**異なれば** `+50点`
- **(A) 公平性:** その時点での合計勤務時間が全メンバーの平均より**少なければ** `+10点`

#### **5. Googleスプレッドシート テーブル設計**
以下の5つのシートで構成されます。

**1. `member_master` （メンバーマスタ）**
- **役割:** メンバーの固定情報を管理。
- **カラム:**
    - `memberId` (文字列, 例: `A001`): メンバーの一意なID
    - `name` (文字列, 例: `山田 太郎`): 氏名
    - `grade` (数値, 例: `3`): 学年

**2. `availability_sheet` （希望シフト）**
- **役割:** メンバーが出勤できない時間帯を管理。
- **カラム:**
    - `memberId` (文字列): どのメンバーのNG時間かを示すID
    - `ngStartDateTime` (日時, 例: `2025/11/08 14:00`): NG期間の開始日時
    - `ngEndDateTime` (日時, 例: `2025/11/08 18:00`): NG期間の終了日時

**3. `time_slot_master` （時間枠マスタ）**
- **役割:** シフトを割り当てるべき全ての時間枠を定義。
- **カラム:**
    - `date` (日付, 例: `2025/11/08`): シフトの日付
    - `startTime` (時刻, 例: `11:00`): シフトの開始時刻
    - `endTime` (時刻, 例: `12:00`): シフトの終了時刻
- **登録データ例:**
    - 土曜日: 11:00-12:00, 12:00-13:00, 13:00-14:00, 14:00-15:00, 15:00-16:00, 16:00-17:00, 17:00-17:30
    - 日曜日: 11:00-12:00, 12:00-13:00, 13:00-14:00, 14:00-15:00, 15:00-16:00, 16:00-16:30

**4. `shift_result_overall` （シフト結果_全体）**
- **役割:** GASによる割り当て結果を出力するシート。このシートは手動での修正も想定。
- **カラム:**
    - `date` (日付): シフトの日付
    - `startTime` (時刻): シフトの開始時刻
    - `endTime` (時刻): シフトの終了時刻
    - `レジ` (文字列): レジ担当のメンバー氏名
    - `商品渡し` (文字列): 商品渡し担当のメンバー氏名
    - `調理` (文字列): 調理担当のメンバー氏名

**5. `shift_result_individual` （シフト結果_個人別）**
- **役割:** 特定のメンバーのシフトのみを抽出して表示。
- **仕様:**
    - A1セルなどに`member_master`の氏名リストから選択できるプルダウンを設置。
    - プルダウンで選択されたメンバーのシフト情報を、`shift_result_overall`シートから自動的に抽出し、表示する。

#### **6. GASの処理フロー案**
1.  **データ読み込み:** `member_master`, `availability_sheet`, `time_slot_master`の各シートから情報を読み込み、処理しやすい形式（オブジェクトの配列など）に変換する。
2.  **初期化:** 各メンバーの割り当て状況（合計勤務時間、経験済み役割、ペア履歴）を管理する内部オブジェクトを初期化する。
3.  **時間枠ループ:** `time_slot_master`で定義された時間枠を、時系列順に1つずつ処理する。
4.  **候補者選定:** 各時間枠において、以下の処理を行う。
    a. **絶対条件フィルタ:** その時間帯に出勤可能で、連続勤務にならないメンバーをリストアップする。
    b. **役割ごとの割り当て:** `レジ`, `商品渡し`, `調理`の順に担当者を決定する。
        i.  1人目（レジ）: 候補者全員をスコアリングし、最高得点者を割り当てる。
        ii. 2人目（商品渡し）: 残りの候補者を、1人目とのペア相性も考慮してスコアリングし、最高得点者を割り当てる。
        iii. 3人目（調理）: さらに残った候補者を、1人目・2人目とのペア相性も考慮してスコアリングし、最高得点者を割り当てる。
    c. **割り当て情報更新:** その時間枠の担当者が3人決まったら、彼らの割り当て状況（合計勤務時間、経験済み役割、ペア履歴）を内部オブジェクト上で更新する。
5.  **結果出力:** 全ての時間枠の処理が完了したら、最終的な割り当て結果を`shift_result_overall`シートに書き出す。

以上の要件と設計に基づき、コードの実装をお願いします。